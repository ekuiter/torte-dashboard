<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<link rel="icon" href="./svgs/favicon.svg" type="image/svg+xml">
	<link rel="stylesheet" href="styles.css">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Centered Iframe with Top Bar</title>
</head>

<body>
	<div id="side-menu">
		<button id="close-menu" class="menu-button" style="margin-bottom: 8px;">Close &#x2715;</button>
		<div id="query-container">
			<label for="query-input">Search:</label>
			<input type="text" id="archQuery" placeholder="Architecture or Project" , value="" style="height: 30px">
		</div>
		<ul class="menu-list" id="menu-items">
		</ul>
	</div>

	<!-- Top Bar -->
	<div id="top-bar">
		<div>

			<button id="menu-button" class="menu-button">Switch Project â˜°</button>
		</div>
		<div style="text-align: center;">

			<div id="title">Torte Dashboard</div>
		</div>
		<div>

			<select id="dataSelector" style="height:30px; padding: 8px; float:right">
			</select>
		</div>
	</div>

	<div class="grid-container">
		<div class="card" style="grid-column-start: 1; grid-column-end: 2;">
			<h2>Current Value<h2>
			<p id="currentValue"></p>
		</div>
		<div class="card" style="grid-column-start: 2; grid-column-end: 6; grid-row-start: 1; grid-row-end: 4;">
			<h2 id="iframeHeader"></h2>
			<div id="iframe-container">
				<iframe align="center" title="Plot" id="plot"
					style="height:800px;width:1510px;border:none;display:block"></iframe>
			</div>
		</div>
		<div class="card" style="grid-column-start: 6; grid-column-end: 7; grid-row-start: 1; grid-row-end: 4;">
			<h2>Description:<h2>
			<p id="plotDesc"></p>
		</div>
		<div class="card" style="grid-column-start: 1; grid-column-end: 2; grid-row-start: 2; grid-row-end: 3;">
			<h2>Compared to last Week:<h2>
			<p id="lastWeek"></p>
		</div>
		<div class="card" style="grid-column-start: 1; grid-column-end: 2; grid-row-start: 3; grid-row-end: 4;">
			<h2>Compared to last month:<h2>
			<p id="lastMonth"></p>
		</div>
	</div>
	<script>
		let keys = [];
		let selectedPlot = "";
		let selectedProj = "";
		let titleProj = document.getElementById("iframeHeader");
		let s = document.getElementById("dataSelector");
		let plotDesc = document.getElementById("plotDesc")
		let lastWeekP = document.getElementById("lastWeek")
		let lastMonthP = document.getElementById("lastMonth")
		let currentValueP = document.getElementById("currentValue")
		let allData = {}
		s.addEventListener("change", (event) => {
			selectedPlot = event.target.selectedOptions[0].id
			titleProj.innerText = `Selected: ${allData.plotData[selectedPlot]["title"]} for ${selectedProj}`
			getPlot()
		});

		// Function to load and display JSON data
		function loadJsonData() {
			fetch('public/init.json')  // Fetch the JSON file
				.then(response => response.json())  // Parse it as JSON
				.then(data => {
					allData = data;
					console.log(allData)
					let projects = Array.from(Object.keys(data.projectData))
					let plots = Array.from(Object.keys(data.plotData))
					console.log(plots)
					let m = document.getElementById("menu-items");
					let i = 0;
					console.log()
					for (const proj of projects) {
						if (i == 0) {
							selectedProj = proj;
							let j = 0;
							let setDef = false;
							for (const plot of plots) {
								console.log(plot)
								var o = document.createElement('option');
								o.id = plot
								o.value = `option${j}`
								o.title = data.plotData[plot]["title"]
								o.innerText = data.plotData[plot]["title"]
								if (plot in data.projectData[proj]) {
									o.hidden = false
									if (setDef == false) {
										selectedPlot = o.id
										titleProj.innerText = `Selected: ${selectedPlot} for ${proj} (Default)`
										o.selected = true;
										setDef = true;
									}
								}
								else {
									o.classList.add("linuxOnly")
									o.hidden = true;
								}
								j++;
								s.appendChild(o);
							}
						}
						var o = document.createElement('li');
						o.id = proj
						o.addEventListener("click", function () {
							document.getElementById("side-menu").classList.remove("active");
							titleProj.innerText = `Selected ${selectedPlot} for ${proj}`
							selectedProj = proj;
							let updated = false;
							Array.from(s.options).forEach(function (option_element) {
								if (!(selectedPlot in allData.projectData[selectedProj])) {
									if (!updated && option_element.id in allData.projectData[selectedProj]) {
										option_element.selected = true
										updated = true;
										selectedPlot = option_element.id
									}
								}
								if (option_element.id in allData.projectData[selectedProj]) {
									option_element.hidden = false;
								}
								else {
									option_element.hidden = true;
								}
							});
							getPlot()
						})
						o.innerText = proj
						m.appendChild(o);
						i++
					}
					getPlot()

				})
				.catch(error => {
					console.error('Error loading JSON:', error);
				});
		}

		function getPlot() {
			const path = `./public/figures/${selectedPlot}/${selectedPlot}-${selectedProj.replace("/", "-")}.html`
			titleProj.innerText = `Selected ${allData.plotData[selectedPlot]["title"]} for ${selectedProj}`
			document.getElementById("plot").src = path
			plotDesc.innerText = allData.plotData[selectedPlot]["desc"]
			currentValueP.innerText = allData.projectData[selectedProj][selectedPlot].currentValue ?? "n.A."
			lastWeekP.innerText = allData.projectData[selectedProj][selectedPlot].cmpLastWeek ?? "n.A."
			lastMonthP.innerText = allData.projectData[selectedProj][selectedPlot].cmpLastMonth ?? "n.A."
		}
		document.getElementById("menu-button").addEventListener("click", function () {
			document.getElementById("side-menu").classList.add("active");
		});
		document.getElementById("close-menu").addEventListener("click", function () {
			document.getElementById("side-menu").classList.remove("active");
		});
		// Call loadJsonData on page load
		window.addEventListener('load', loadJsonData);
		document.getElementById("archQuery").addEventListener("input", (event) => {
			let root = document.getElementById("menu-items");
			for (var child in root.childNodes) {
				let element = root.childNodes[child];
				if (event.target.value === "") {
					element.hidden = false;
					continue;
				}
				if (element.tagName != "LI") {
					continue
				}
				let lowerStr1 = event.target.value.toLowerCase();
				let lowerStr2 = element.innerText.toLowerCase();

				if (lowerStr2.includes(lowerStr1)) {
					element.hidden = false;
				} else {
					element.hidden = true;
				}
			}
		});

	</script>
</body>

</html>